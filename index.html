<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Templar Rule Dashboard</title>

    <!-- Optional: Templar-ish fonts (falls back gracefully if blocked) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=EB+Garamond:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <!-- React 18 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel (fine for static MVP) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      :root{
        --bg:#070a10;
        --bg2:#0a1020;
        --panel:#0d1424;
        --panel2:#0b111d;

        --text:#e8edf5;
        --muted:#9fb0c0;
        --line:#1b2a45;

        --gold:#d6b15e;
        --gold2:#b7923e;
        --steel:#9fb0c0;
        --danger:#ff6b6b;
        --good:#35c07a;
        --warn:#f2c94c;

        --chip:#111b30;
        --shadow: 0 10px 30px rgba(0,0,0,.35);

        --radius: 14px;
        --radius2: 12px;
      }

      *{box-sizing:border-box}
      body{
        margin:0;
        color:var(--text);
        background:
          radial-gradient(1100px 700px at 20% 0%, #0d1a33 0%, var(--bg) 58%),
          radial-gradient(800px 500px at 85% 15%, rgba(214,177,94,.10) 0%, transparent 55%),
          linear-gradient(180deg, var(--bg2), var(--bg));
        font-family: "EB Garamond", ui-serif, Georgia, Cambria, "Times New Roman", Times, serif;
      }

      button, input, select, textarea { font: inherit; }

      .app{
        max-width: 760px;
        margin: 0 auto;
        padding-bottom: calc(86px + env(safe-area-inset-bottom)); /* room for bottom nav */
      }

      /* Header */
      .header{
        position: sticky;
        top: 0;
        z-index: 10;
        backdrop-filter: blur(10px);
        background: rgba(7,10,16,.72);
        border-bottom: 1px solid rgba(27,42,69,.55);
      }
      .headerInner{
        padding: 12px 14px 10px;
        display:flex;
        align-items:flex-end;
        justify-content: space-between;
        gap: 10px;
      }
      .brand{
        display:flex;
        flex-direction: column;
        gap: 4px;
      }
      .brandTitle{
        font-family: "Cinzel", ui-serif, serif;
        font-weight: 700;
        letter-spacing: .6px;
        font-size: 14px;
        display:flex;
        align-items:center;
        gap: 8px;
      }
      .brandTitle .sigil{
        width: 16px; height: 16px;
        display:inline-flex;
      }
      .brandSub{
        font-size: 12px;
        color: var(--muted);
        line-height: 1.25;
      }
      .statusPills{
        display:flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content:flex-end;
      }
      .chip{
        display:inline-flex;
        align-items:center;
        gap: 6px;
        padding: 5px 10px;
        border-radius: 999px;
        border: 1px solid rgba(27,42,69,.8);
        background: rgba(17,27,48,.75);
        color: var(--muted);
        font-size: 11px;
        white-space: nowrap;
      }
      .chip.gold{
        border-color: rgba(214,177,94,.45);
        color: #f3e7c6;
        background: rgba(214,177,94,.10);
      }
      .chip.good{
        border-color: rgba(53,192,122,.35);
        color: #c9f3df;
        background: rgba(53,192,122,.10);
      }
      .chip.warn{
        border-color: rgba(242,201,76,.35);
        color: #fff1b3;
        background: rgba(242,201,76,.08);
      }
      .chip.bad{
        border-color: rgba(255,107,107,.35);
        color: #ffd0d0;
        background: rgba(255,107,107,.09);
      }

      /* Content */
      .content{
        padding: 12px 14px 14px;
      }

      .card{
        background: linear-gradient(180deg, rgba(13,20,36,.95), rgba(11,17,29,.92));
        border: 1px solid rgba(27,42,69,.85);
        border-radius: var(--radius);
        padding: 12px;
        box-shadow: var(--shadow);
      }
      .card + .card{ margin-top: 12px; }

      .cardTitle{
        display:flex;
        align-items:center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
      }
      .cardTitle h2{
        margin:0;
        font-family:"Cinzel", ui-serif, serif;
        font-weight: 700;
        letter-spacing: .5px;
        font-size: 13px;
      }
      .meta{
        font-size: 12px;
        color: var(--muted);
        font-weight: 600;
      }

      .row{
        display:flex;
        gap: 8px;
        align-items:center;
        flex-wrap: wrap;
      }
      .input{
        width: 100%;
        padding: 11px 12px;
        border-radius: var(--radius2);
        border: 1px solid rgba(27,42,69,.85);
        background: rgba(7,10,16,.55);
        color: var(--text);
        outline: none;
      }
      .input:focus{
        border-color: rgba(214,177,94,.6);
        box-shadow: 0 0 0 3px rgba(214,177,94,.10);
      }

      .btn{
        border-radius: 12px;
        padding: 10px 12px;
        border: 1px solid rgba(27,42,69,.95);
        background: rgba(7,10,16,.40);
        color: var(--text);
        cursor: pointer;
      }
      .btn:active{ transform: translateY(1px); }
      .btn.primary{
        border-color: rgba(214,177,94,.55);
        background: linear-gradient(180deg, rgba(214,177,94,.18), rgba(183,146,62,.08));
      }
      .btn.danger{
        border-color: rgba(255,107,107,.5);
        background: rgba(255,107,107,.10);
      }
      .btn.ghost{ background: transparent; }

      .small{ font-size: 12px; color: var(--muted); line-height: 1.35; }
      .divider{ height: 1px; background: rgba(27,42,69,.85); margin: 10px 0; }

      /* Tasks */
      .task{
        border: 1px solid rgba(27,42,69,.85);
        background: rgba(7,10,16,.38);
        border-radius: 14px;
        padding: 11px;
        margin-bottom: 10px;
      }
      .taskTop{
        display:flex;
        align-items:flex-start;
        justify-content: space-between;
        gap: 10px;
      }
      .taskTitle{
        margin:0;
        font-size: 14px;
        line-height: 1.25;
        letter-spacing: .1px;
      }
      .taskMeta{
        margin-top: 7px;
        display:flex;
        gap: 6px;
        flex-wrap: wrap;
        align-items:center;
      }
      .miniBtn{
        border-radius: 12px;
        padding: 9px 10px;
        border: 1px solid rgba(27,42,69,.95);
        background: rgba(7,10,16,.40);
        color: var(--text);
        cursor: pointer;
        font-size: 12px;
        min-height: 40px; /* thumb target */
      }
      .miniBtn.good{ border-color: rgba(53,192,122,.45); }
      .miniBtn.gold{ border-color: rgba(214,177,94,.55); }
      .miniBtn.bad{ border-color: rgba(255,107,107,.45); }

      .details{
        margin-top: 10px;
        padding: 10px;
        border-radius: 14px;
        border: 1px dashed rgba(214,177,94,.35);
        background: rgba(214,177,94,.06);
      }
      .textarea{
        width:100%;
        min-height: 88px;
        padding: 10px 10px;
        border-radius: 12px;
        border: 1px solid rgba(27,42,69,.85);
        background: rgba(7,10,16,.55);
        color: var(--text);
        outline:none;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
        line-height: 1.35;
      }

      /* Timer */
      .timerWrap{
        display:flex;
        align-items:flex-start;
        justify-content: space-between;
        gap: 10px;
      }
      .timerBig{
        font-family: "Cinzel", ui-serif, serif;
        font-size: 42px;
        letter-spacing: 1px;
        margin: 2px 0;
      }
      .timerLabel{ font-size: 12px; color: var(--muted); }
      .callout{
        border-radius: 14px;
        border: 1px dashed rgba(214,177,94,.35);
        background: rgba(214,177,94,.06);
        padding: 10px;
      }

      /* Bottom Nav */
      .bottomNav{
        position: fixed;
        left: 0; right: 0; bottom: 0;
        z-index: 30;
        padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
        backdrop-filter: blur(10px);
        background: rgba(7,10,16,.80);
        border-top: 1px solid rgba(27,42,69,.60);
      }
      .navRow{
        max-width: 760px;
        margin: 0 auto;
        display:grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 8px;
      }
      .navBtn{
        display:flex;
        flex-direction: column;
        align-items:center;
        justify-content:center;
        gap: 4px;
        min-height: 56px;
        border-radius: 14px;
        border: 1px solid rgba(27,42,69,.85);
        background: rgba(7,10,16,.35);
        color: var(--muted);
        cursor:pointer;
      }
      .navBtn.active{
        border-color: rgba(214,177,94,.55);
        background: rgba(214,177,94,.10);
        color: #f3e7c6;
      }
      .navIcon{ width: 18px; height: 18px; display:inline-flex; }
      .navLabel{ font-size: 11px; font-weight: 600; letter-spacing: .2px; }

      /* Modal */
      .modalOverlay{
        position: fixed;
        inset:0;
        background: rgba(0,0,0,.60);
        display:flex;
        align-items:center;
        justify-content:center;
        padding: 14px;
        z-index: 60;
      }
      .modal{
        width: min(720px, 100%);
        max-height: 88vh;
        overflow:auto;
        border-radius: 16px;
        border: 1px solid rgba(27,42,69,.9);
        background: linear-gradient(180deg, rgba(13,20,36,.98), rgba(11,17,29,.95));
        box-shadow: var(--shadow);
        padding: 12px;
      }
      .modalHeader{
        display:flex;
        align-items:center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
      }

      /* Make text less cramped on narrow devices */
      @media (max-width: 380px){
        .navRow{ gap: 6px; }
        .navBtn{ min-height: 52px; }
        .timerBig{ font-size: 38px; }
      }
    </style>
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useState } = React;

      const LS_KEY = "templar_dashboard_mobile_v1";

      const MOVES = [
        "1 minute walk (inside/outside).",
        "10 air squats (slow).",
        "10 incline pushups (hands on counter).",
        "30 sec nasal breathing + drop shoulders.",
        "Shoulder CARs x 3 each side.",
        "Hip hinge x 10 (easy range).",
        "Couch stretch 45 sec each side.",
        "Scap circles x 10 + neck release.",
      ];

      function localISODate(d = new Date()){
        const pad = n => String(n).padStart(2,"0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      }
      function uid(){
        return crypto?.randomUUID ? crypto.randomUUID() : String(Date.now())+"_"+Math.random().toString(16).slice(2);
      }
      function safeParseJSON(text){
        try{ return {ok:true, value: JSON.parse(text)}; }
        catch(e){ return {ok:false, error: e?.message || "Invalid JSON"}; }
      }
      function pad2(n){ return String(n).padStart(2,"0"); }
      function fmtTime(d){
        const h = d.getHours();
        const m = d.getMinutes();
        const ampm = h >= 12 ? "PM" : "AM";
        const hh = h % 12 === 0 ? 12 : h % 12;
        return `${hh}:${pad2(m)} ${ampm}`;
      }
      function phaseOfDay(d){
        const h = d.getHours();
        if (h >= 5 && h < 11) return "morning";
        if (h >= 11 && h < 17) return "midday";
        if (h >= 17 && h < 22) return "evening";
        return "night";
      }
      function randMove(){
        return MOVES[Math.floor(Math.random() * MOVES.length)];
      }

      function defaultState(){
        const t = localISODate();
        return {
          meta:{ version: 1, lastOpenedDate: t },
          formation:{
            dailyLedger:[{
              date:t,
              ora:{ prime:false, terce:false, vespers:false, compline:false },
              labora:{ stewardship:false, projectBlock:false },
              pugna:{ training:false, custody:false },
              mercy:false,
              thanksgiving:"",
              repentance:"",
              obedienceTomorrow:"",
            }]
          },
          tasks:[
            { id: uid(), title:"Capture tasks into Inbox", lane:"inbox", done:false, kind:"general", due:null, notes:"", nextTinyStep:"", timerPreset:15, order:1, createdAt:new Date().toISOString() },
            { id: uid(), title:"Pick Top 3–5 for Today", lane:"today", done:false, kind:"general", due:t, notes:"", nextTinyStep:"Open dashboard → choose 3–5 → start #1.", timerPreset:15, order:2, createdAt:new Date().toISOString() },
            { id: uid(), title:"Make one Stewardship packet (tax/insurance/docs/credit)", lane:"later", done:false, kind:"ops", due:null, notes:"Checklist + links/IDs (no passwords).", nextTinyStep:"Create a 5-bullet checklist.", timerPreset:25, order:3, createdAt:new Date().toISOString() },
          ],
        };
      }

      function ensureTodayLedger(formation){
        const t = localISODate();
        const f = formation && typeof formation === "object" ? formation : { dailyLedger: [] };
        const dl = Array.isArray(f.dailyLedger) ? f.dailyLedger : [];
        if (dl.some(e => e.date === t)) return { ...f, dailyLedger: dl };
        return {
          ...f,
          dailyLedger: [...dl, {
            date:t,
            ora:{ prime:false, terce:false, vespers:false, compline:false },
            labora:{ stewardship:false, projectBlock:false },
            pugna:{ training:false, custody:false },
            mercy:false,
            thanksgiving:"",
            repentance:"",
            obedienceTomorrow:"",
          }]
        };
      }

      function normalizeState(s){
        const base = defaultState();
        const obj = (s && typeof s === "object") ? s : base;

        const meta = (obj.meta && typeof obj.meta === "object") ? obj.meta : base.meta;
        const formation = ensureTodayLedger(obj.formation || base.formation);
        const tasks = Array.isArray(obj.tasks) ? obj.tasks : base.tasks;

        // Keep Today ≤ 5 (first by order)
        const openToday = tasks
          .filter(t => t && !t.done && t.lane === "today")
          .sort((a,b)=>(a.order||0)-(b.order||0));
        const overflow = openToday.slice(5).map(t => String(t.id));

        const tasks2 = tasks.map(t => {
          if (!t || typeof t !== "object") return null;
          const lane = ["inbox","today","later"].includes(t.lane) ? t.lane : "inbox";
          const done = !!t.done;
          const id = String(t.id || uid());

          const out = {
            id,
            title: String(t.title || "").slice(0,240),
            lane,
            done,
            kind: ["general","ops","project"].includes(t.kind) ? t.kind : "general",
            due: t.due ? String(t.due).slice(0,10) : null,
            notes: String(t.notes || "").slice(0,2000),
            nextTinyStep: String(t.nextTinyStep || "").slice(0,220),
            timerPreset: [10,15,25,45].includes(Number(t.timerPreset)) ? Number(t.timerPreset) : 15,
            order: typeof t.order === "number" ? t.order : Date.now(),
            createdAt: t.createdAt ? String(t.createdAt) : new Date().toISOString(),
          };

          if (overflow.includes(id) && out.lane === "today" && !out.done) out.lane = "later";
          return out;
        }).filter(Boolean);

        return {
          meta: {
            version: 1,
            lastOpenedDate: meta.lastOpenedDate ? String(meta.lastOpenedDate).slice(0,10) : localISODate(),
          },
          formation,
          tasks: tasks2,
        };
      }

      function loadState(){
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return defaultState();
        const parsed = safeParseJSON(raw);
        if (!parsed.ok) return defaultState();
        return normalizeState(parsed.value);
      }
      function saveState(s){
        localStorage.setItem(LS_KEY, JSON.stringify(s, null, 2));
      }

      function getTodayLedger(formation){
        const t = localISODate();
        const f = ensureTodayLedger(formation);
        const e = (f.dailyLedger || []).find(x => x.date === t);
        return e || (f.dailyLedger || [])[f.dailyLedger.length - 1];
      }

      function deepMerge(a, b){
        const out = { ...a };
        for (const k of Object.keys(b || {})) {
          const v = b[k];
          if (v && typeof v === "object" && !Array.isArray(v)) {
            out[k] = deepMerge(a?.[k] || {}, v);
          } else {
            out[k] = v;
          }
        }
        return out;
      }

      // Icons (inline SVG)
      const Icon = {
        cross: () => (
          <svg viewBox="0 0 24 24" fill="none" className="navIcon" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 3h4v6h6v4h-6v8h-4v-8H4V9h6V3z" fill="currentColor" opacity=".95"/>
          </svg>
        ),
        today: () => (
          <svg viewBox="0 0 24 24" fill="none" className="navIcon" xmlns="http://www.w3.org/2000/svg">
            <path d="M7 3v2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2V3h-2v2H9V3H7zm12 6H5v10h14V9z" fill="currentColor"/>
          </svg>
        ),
        inbox: () => (
          <svg viewBox="0 0 24 24" fill="none" className="navIcon" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 4h16v10h-5l-3 3-3-3H4V4zm0 12h4l4 4 4-4h4v4H4v-4z" fill="currentColor"/>
          </svg>
        ),
        later: () => (
          <svg viewBox="0 0 24 24" fill="none" className="navIcon" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2zm1 5h-2v6l5 3 1-1.732-4-2.268V7z" fill="currentColor"/>
          </svg>
        ),
        focus: () => (
          <svg viewBox="0 0 24 24" fill="none" className="navIcon" xmlns="http://www.w3.org/2000/svg">
            <path d="M7 3H3v4h2V5h2V3zm14 0h-4v2h2v2h2V3zM5 17H3v4h4v-2H5v-2zm16 0h-2v2h-2v2h4v-4zM12 7a5 5 0 1 0 .001 10.001A5 5 0 0 0 12 7z" fill="currentColor"/>
          </svg>
        ),
        rule: () => (
          <svg viewBox="0 0 24 24" fill="none" className="navIcon" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 2h12a2 2 0 0 1 2 2v16l-3-2-3 2-3-2-3 2-3-2-3 2V4a2 2 0 0 1 2-2zm2 6h8v2H8V8zm0 4h8v2H8v-2z" fill="currentColor"/>
          </svg>
        ),
        json: () => (
          <svg viewBox="0 0 24 24" fill="none" className="navIcon" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 4H6c-1.1 0-2 .9-2 2v4h2V6h2V4zm10 0h-2v2h2v4h2V6c0-1.1-.9-2-2-2zM6 18H4v4c0 1.1.9 2 2 2h2v-2H6v-4zm14 0h-2v4h-2v2h2c1.1 0 2-.9 2-2v-4zM9 9h6v2H9V9zm0 4h6v2H9v-2z" fill="currentColor"/>
          </svg>
        ),
      };

      function App(){
        const [state, setState] = useState(() => loadState());
        const [now, setNow] = useState(() => new Date());
        const [tab, setTab] = useState("today"); // today | inbox | later | focus | rule | json
        const [toast, setToast] = useState("");

        // Quick add
        const [newTitle, setNewTitle] = useState("");
        const [newLane, setNewLane] = useState("inbox");
        const [newKind, setNewKind] = useState("general");
        const [newPreset, setNewPreset] = useState(15);

        // Task details toggle
        const [expandedTaskId, setExpandedTaskId] = useState(null);

        // JSON
        const [showJSON, setShowJSON] = useState(false);
        const [jsonText, setJsonText] = useState("");
        const [jsonMsg, setJsonMsg] = useState("");

        // Timer
        const [timer, setTimer] = useState({
          mode: "idle",        // idle | focus | break
          running: false,
          secondsLeft: 0,
          taskId: null,
          movePrompt: "",
        });

        // clock tick
        useEffect(() => {
          const id = setInterval(() => setNow(new Date()), 1000);
          return () => clearInterval(id);
        }, []);

        // daily rollover
        useEffect(() => {
          const t = localISODate();
          if (state.meta.lastOpenedDate !== t) {
            const next = {
              ...state,
              meta: { ...state.meta, lastOpenedDate: t },
              tasks: state.tasks.map(task => (task.lane === "today" && !task.done) ? { ...task, lane: "later" } : task),
              formation: ensureTodayLedger(state.formation),
            };
            setState(normalizeState(next));
            setTimer({ mode:"idle", running:false, secondsLeft:0, taskId:null, movePrompt:"" });
            setToast("New day: moved unfinished Today items to Later.");
          } else {
            setState(prev => normalizeState(prev));
          }
          // eslint-disable-next-line react-hooks/exhaustive-deps
        }, []);

        useEffect(() => saveState(state), [state]);

        // timer tick
        useEffect(() => {
          if (!timer.running) return;
          const id = setInterval(() => {
            setTimer(prev => {
              if (!prev.running) return prev;
              const next = { ...prev, secondsLeft: Math.max(0, prev.secondsLeft - 1) };
              if (next.secondsLeft <= 0) {
                if (prev.mode === "focus") {
                  const prompt = randMove();
                  setToast("Focus complete. Take a movement break.");
                  return { mode:"break", running:false, secondsLeft: 2*60, taskId: prev.taskId, movePrompt: prompt };
                }
                if (prev.mode === "break") {
                  setToast("Break complete. Start the next focus.");
                  return { mode:"idle", running:false, secondsLeft:0, taskId:null, movePrompt:"" };
                }
              }
              return next;
            });
          }, 1000);
          return () => clearInterval(id);
        }, [timer.running]);

        function commit(next){
          setState(normalizeState(next));
        }

        function addTask(){
          const title = newTitle.trim();
          if (!title) return;
          const task = {
            id: uid(),
            title,
            lane: newLane,
            done: false,
            kind: newKind,
            due: null,
            notes: "",
            nextTinyStep: "",
            timerPreset: Number(newPreset) || 15,
            order: Date.now(),
            createdAt: new Date().toISOString(),
          };
          commit({ ...state, tasks: [...state.tasks, task] });
          setNewTitle("");
          setToast("Captured.");
        }

        function toggleDone(taskId){
          commit({ ...state, tasks: state.tasks.map(t => t.id === taskId ? { ...t, done: !t.done } : t) });
        }
        function moveTask(taskId, lane){
          commit({ ...state, tasks: state.tasks.map(t => t.id === taskId ? { ...t, lane } : t) });
        }
        function editTask(taskId, patch){
          commit({ ...state, tasks: state.tasks.map(t => t.id === taskId ? { ...t, ...patch } : t) });
        }

        function updateLedger(patch){
          const t = localISODate();
          const f = ensureTodayLedger(state.formation);
          const dl = (f.dailyLedger || []).map(e => (e.date === t ? deepMerge(e, patch) : e));
          commit({ ...state, formation: { ...f, dailyLedger: dl } });
        }

        function resetAll(){
          if (!confirm("Reset everything to defaults? This wipes local data.")) return;
          commit(defaultState());
          setTimer({ mode:"idle", running:false, secondsLeft:0, taskId:null, movePrompt:"" });
          setToast("Reset.");
        }

        // JSON
        function exportJSON(){
          const text = JSON.stringify(state, null, 2);
          setJsonText(text);
          setShowJSON(true);
          setJsonMsg("");
          navigator.clipboard?.writeText(text).then(
            () => setJsonMsg("Copied JSON ✅"),
            () => setJsonMsg("Copy manually from the box.")
          );
        }
        function importJSON(){
          const parsed = safeParseJSON(jsonText);
          if (!parsed.ok) { setJsonMsg("Import failed: " + parsed.error); return; }
          commit(parsed.value);
          setShowJSON(false);
          setJsonMsg("Imported ✅");
          setToast("Imported state.");
        }

        // Timer helpers
        const tasksOpen = useMemo(() => state.tasks.filter(t => !t.done), [state.tasks]);
        const tasksByLane = useMemo(() => {
          const lanes = { inbox: [], today: [], later: [] };
          const sorted = [...tasksOpen].sort((a,b)=>(a.order||0)-(b.order||0));
          for (const t of sorted) lanes[t.lane].push(t);
          return lanes;
        }, [tasksOpen]);

        const phase = phaseOfDay(now);
        const phaseChip = useMemo(() => {
          if (phase === "morning") return { cls:"good", label:"Morning" };
          if (phase === "midday") return { cls:"warn", label:"Midday" };
          if (phase === "evening") return { cls:"", label:"Evening" };
          return { cls:"bad", label:"Night" };
        }, [phase]);

        const todayLedger = useMemo(() => getTodayLedger(state.formation), [state.formation]);

        const currentTask = useMemo(() => {
          if (!timer.taskId) return null;
          return state.tasks.find(t => t.id === timer.taskId) || null;
        }, [timer.taskId, state.tasks]);

        function fmtMMSS(sec){
          const m = Math.floor(sec / 60);
          const s = sec % 60;
          return `${m}:${pad2(s)}`;
        }

        function startFocusForTask(task){
          const mins = Number(task.timerPreset) || 15;
          const step = (task.nextTinyStep || "").trim();
          setTimer({ mode:"focus", running:true, secondsLeft: mins*60, taskId: task.id, movePrompt:"" });
          setTab("focus");
          setToast(step ? `Start: ${step}` : "Start focus.");
        }
        function startTopToday(){
          const top = tasksByLane.today[0];
          if (!top) { setToast("No Today tasks. Move one from Later."); return; }
          startFocusForTask(top);
        }
        function toggleTimerRun(){
          setTimer(prev => prev.mode === "idle" ? prev : { ...prev, running: !prev.running });
        }
        function resetTimer(){
          setTimer({ mode:"idle", running:false, secondsLeft:0, taskId:null, movePrompt:"" });
          setToast("Timer reset.");
        }
        function setFocusPreset(mins){
          setTimer(prev => (prev.mode !== "focus" ? prev : { ...prev, secondsLeft: mins*60, running:false }));
        }
        function setBreakPreset(mins){
          setTimer(prev => (prev.mode !== "break" ? prev : { ...prev, secondsLeft: mins*60, running:false }));
        }
        function startBreakNow(){
          setTimer(prev => {
            const prompt = prev.movePrompt || randMove();
            return { mode:"break", running:true, secondsLeft: prev.secondsLeft > 0 ? prev.secondsLeft : 2*60, taskId: prev.taskId, movePrompt: prompt };
          });
        }
        function completeCurrentTask(){
          if (!currentTask) return;
          toggleDone(currentTask.id);
          setToast("Marked done ✅");
        }

        // Render tab content
        const tabTitle = (t) => ({
          today: "Today",
          inbox: "Inbox",
          later: "Later",
          focus: "Focus",
          rule: "Rule",
          json: "JSON",
        }[t] || t);

        return (
          <>
            <div className="app">
              {/* Header */}
              <div className="header">
                <div className="headerInner">
                  <div className="brand">
                    <div className="brandTitle">
                      <span className="sigil" aria-hidden="true"><Icon.cross /></span>
                      Templar Rule Dashboard
                    </div>
                    <div className="brandSub">
                      {tabTitle(tab)} • Today ≤ 5 • {fmtTime(now)} • {localISODate(now)}
                    </div>
                  </div>

                  <div className="statusPills">
                    <span className={`chip ${phaseChip.cls}`}>{phaseChip.label}</span>
                    <span className="chip gold">Open: {tasksOpen.length}</span>
                    <span className={`chip ${tasksByLane.today.length > 5 ? "bad" : "gold"}`}>Today: {tasksByLane.today.length}/5</span>
                  </div>
                </div>
              </div>

              <div className="content">
                {/* Quick add (mobile-friendly) */}
                {(tab === "today" || tab === "inbox" || tab === "later") && (
                  <div className="card">
                    <div className="cardTitle">
                      <h2>Capture</h2>
                      <div className="meta">Fast, then decide later</div>
                    </div>

                    <div className="row">
                      <input
                        className="input"
                        placeholder="Quick add… (Enter to save)"
                        value={newTitle}
                        onChange={(e)=>setNewTitle(e.target.value)}
                        onKeyDown={(e)=>{ if(e.key==="Enter") addTask(); }}
                      />
                    </div>

                    <div className="row" style={{marginTop:10}}>
                      <select className="input" value={newLane} onChange={(e)=>setNewLane(e.target.value)} style={{flex:1, minWidth: 120}}>
                        <option value="inbox">Inbox</option>
                        <option value="today">Today</option>
                        <option value="later">Later</option>
                      </select>

                      <select className="input" value={newKind} onChange={(e)=>setNewKind(e.target.value)} style={{flex:1, minWidth: 140}}>
                        <option value="general">General</option>
                        <option value="ops">Ops (Stewardship)</option>
                        <option value="project">Project (Mission)</option>
                      </select>

                      <select className="input" value={newPreset} onChange={(e)=>setNewPreset(Number(e.target.value))} style={{flex:1, minWidth: 110}}>
                        <option value={15}>15m</option>
                        <option value={25}>25m</option>
                        <option value={45}>45m</option>
                      </select>

                      <button className="btn primary" onClick={addTask} style={{flex:1, minWidth: 110}}>
                        Add
                      </button>
                    </div>

                    <div className="divider"></div>

                    <div className="row" style={{justifyContent:"space-between"}}>
                      <div className="small">
                        Tip: write a <strong>tiny step</strong>, then press <strong>Start</strong>.
                      </div>
                      <button className="btn primary" onClick={startTopToday}>
                        Start Top Today
                      </button>
                    </div>

                    {toast && (
                      <div className="callout" style={{marginTop:10}}>
                        <div className="small"><strong>Note:</strong> {toast}</div>
                        <div style={{marginTop:10}}>
                          <button className="btn ghost" onClick={()=>setToast("")}>Dismiss</button>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Lanes */}
                {tab === "today" && (
                  <Lane
                    title="Today (≤ 5)"
                    subtitle="Only what you will actually do."
                    tasks={tasksByLane.today}
                    lane="today"
                    expandedTaskId={expandedTaskId}
                    setExpandedTaskId={setExpandedTaskId}
                    onDone={toggleDone}
                    onMove={moveTask}
                    onEdit={editTask}
                    onStart={startFocusForTask}
                  />
                )}
                {tab === "inbox" && (
                  <Lane
                    title="Inbox"
                    subtitle="Capture only. No deciding here."
                    tasks={tasksByLane.inbox}
                    lane="inbox"
                    expandedTaskId={expandedTaskId}
                    setExpandedTaskId={setExpandedTaskId}
                    onDone={toggleDone}
                    onMove={moveTask}
                    onEdit={editTask}
                    onStart={startFocusForTask}
                  />
                )}
                {tab === "later" && (
                  <Lane
                    title="Later"
                    subtitle="Everything else (Ops + Projects)."
                    tasks={tasksByLane.later}
                    lane="later"
                    expandedTaskId={expandedTaskId}
                    setExpandedTaskId={setExpandedTaskId}
                    onDone={toggleDone}
                    onMove={moveTask}
                    onEdit={editTask}
                    onStart={startFocusForTask}
                  />
                )}

                {/* Focus */}
                {tab === "focus" && (
                  <div className="card">
                    <div className="cardTitle">
                      <h2>Focus</h2>
                      <div className="meta">Sprints + movement breaks</div>
                    </div>

                    <div className="callout">
                      <div className="timerWrap">
                        <div>
                          <div className="timerLabel">
                            {timer.mode === "idle" ? "Idle" : timer.mode === "focus" ? "Focus" : "Break"}
                            {currentTask ? ` • ${currentTask.title}` : ""}
                          </div>
                          <div className="timerBig">
                            {timer.mode === "idle" ? "—:—" : fmtMMSS(timer.secondsLeft)}
                          </div>
                          <div className="small">
                            {timer.mode === "focus" && currentTask?.nextTinyStep ? (
                              <>Next tiny step: <strong>{currentTask.nextTinyStep}</strong></>
                            ) : timer.mode === "break" && timer.movePrompt ? (
                              <>Move: <strong>{timer.movePrompt}</strong></>
                            ) : (
                              <>Start the top Today task, then obey the timer.</>
                            )}
                          </div>
                        </div>

                        <div className="row" style={{justifyContent:"flex-end"}}>
                          <button className="btn primary" onClick={toggleTimerRun} disabled={timer.mode==="idle"}>
                            {timer.running ? "Pause" : "Start"}
                          </button>
                          <button className="btn" onClick={resetTimer}>Reset</button>
                        </div>
                      </div>

                      <div className="divider"></div>

                      <div className="row" style={{justifyContent:"space-between"}}>
                        <div className="small">
                          Focus:
                          <span style={{marginLeft:8}} />
                          <button className="miniBtn gold" onClick={()=>setFocusPreset(15)} disabled={timer.mode!=="focus"}>15m</button>{" "}
                          <button className="miniBtn gold" onClick={()=>setFocusPreset(25)} disabled={timer.mode!=="focus"}>25m</button>{" "}
                          <button className="miniBtn gold" onClick={()=>setFocusPreset(45)} disabled={timer.mode!=="focus"}>45m</button>
                        </div>

                        <div className="small">
                          Break:
                          <span style={{marginLeft:8}} />
                          <button className="miniBtn" onClick={()=>setBreakPreset(2)} disabled={timer.mode!=="break"}>2m</button>{" "}
                          <button className="miniBtn" onClick={()=>setBreakPreset(5)} disabled={timer.mode!=="break"}>5m</button>{" "}
                          <button className="miniBtn gold" onClick={startBreakNow} disabled={timer.mode!=="break"}>Start break</button>
                        </div>
                      </div>

                      <div style={{marginTop:10}} className="row">
                        <button className="miniBtn good" onClick={completeCurrentTask} disabled={!currentTask}>
                          Mark current task done ✅
                        </button>
                        <button
                          className="miniBtn"
                          onClick={()=>{
                            const nextPrompt = randMove();
                            setTimer(prev => prev.mode==="break" ? { ...prev, movePrompt: nextPrompt } : prev);
                          }}
                          disabled={timer.mode!=="break"}
                        >
                          New move
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                {/* Rule */}
                {tab === "rule" && (
                  <div className="card">
                    <div className="cardTitle">
                      <h2>Rule Ledger</h2>
                      <div className="meta">Ora • Labora • Pugna + Mercy</div>
                    </div>

                    <Ledger
                      phase={phase}
                      ledger={todayLedger}
                      onPatch={updateLedger}
                    />
                  </div>
                )}

                {/* JSON */}
                {tab === "json" && (
                  <div className="card">
                    <div className="cardTitle">
                      <h2>JSON Round-trip</h2>
                      <div className="meta">Export → chat → import</div>
                    </div>

                    <div className="row">
                      <button className="btn primary" onClick={exportJSON}>Export JSON</button>
                      <button className="btn" onClick={()=>setShowJSON(v=>!v)}>{showJSON ? "Hide" : "Import JSON"}</button>
                      <button className="btn danger" onClick={resetAll}>Reset</button>
                    </div>

                    <div className="divider"></div>

                    <div className="small" style={{marginBottom:10}}>
                      Prompt to use with export:
                      <div className="callout" style={{marginTop:8}}>
                        <div className="small">
                          “Set Today ≤ 5, write a tiny step for each, assign timers, and keep at least 1 Ops + 1 Project item if possible. Return UPDATED JSON only.”
                        </div>
                      </div>
                    </div>

                    {showJSON ? (
                      <>
                        <textarea
                          className="textarea"
                          value={jsonText}
                          onChange={(e)=>setJsonText(e.target.value)}
                          placeholder="Paste JSON here to import…"
                          style={{minHeight:200}}
                        />
                        <div className="row" style={{justifyContent:"space-between", marginTop:10}}>
                          <div className="small">{jsonMsg}</div>
                          <div className="row">
                            <button className="btn" onClick={()=>setShowJSON(false)}>Close</button>
                            <button className="btn primary" onClick={importJSON}>Import</button>
                          </div>
                        </div>
                      </>
                    ) : (
                      <div className="small">
                        Tip: you can keep this private and still get full “spiritual father + ADD” prioritization by round-tripping JSON.
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>

            {/* Bottom nav */}
            <div className="bottomNav">
              <div className="navRow">
                <NavButton label="Today" icon={<Icon.today />} active={tab==="today"} onClick={()=>setTab("today")} />
                <NavButton label="Inbox" icon={<Icon.inbox />} active={tab==="inbox"} onClick={()=>setTab("inbox")} />
                <NavButton label="Later" icon={<Icon.later />} active={tab==="later"} onClick={()=>setTab("later")} />
                <NavButton label="Focus" icon={<Icon.focus />} active={tab==="focus"} onClick={()=>setTab("focus")} />
                <NavButton label="Rule" icon={<Icon.rule />} active={tab==="rule"} onClick={()=>setTab("rule")} />
                <NavButton label="JSON" icon={<Icon.json />} active={tab==="json"} onClick={()=>setTab("json")} />
              </div>
            </div>

            {/* Break prompt modal */}
            {timer.mode === "break" && !timer.running && timer.secondsLeft > 0 && (
              <div className="modalOverlay" role="dialog" aria-modal="true">
                <div className="modal">
                  <div className="modalHeader">
                    <div>
                      <div className="brandTitle" style={{fontSize:13}}>
                        <span className="sigil" aria-hidden="true"><Icon.cross /></span>
                        Movement break
                      </div>
                      <div className="small">Do this now, then start the break timer.</div>
                    </div>
                    <button className="btn ghost" onClick={()=>setTimer({mode:"idle",running:false,secondsLeft:0,taskId:null,movePrompt:""})}>✕</button>
                  </div>

                  <div className="callout">
                    <div className="small">Move:</div>
                    <div style={{marginTop:8, fontSize:16}}>
                      <strong>{timer.movePrompt || randMove()}</strong>
                    </div>
                    <div className="divider"></div>
                    <div className="row">
                      <button className="btn primary" onClick={startBreakNow}>Start break timer</button>
                      <button className="btn" onClick={()=>setTimer(prev=>({ ...prev, movePrompt: randMove() }))}>New move</button>
                      <button className="btn" onClick={()=>setTimer({mode:"idle",running:false,secondsLeft:0,taskId:null,movePrompt:""})}>Skip</button>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </>
        );
      }

      function NavButton({ label, icon, active, onClick }){
        return (
          <button className={"navBtn" + (active ? " active" : "")} onClick={onClick} aria-label={label}>
            <span className="navIcon" aria-hidden="true">{icon}</span>
            <span className="navLabel">{label}</span>
          </button>
        );
      }

      function Lane({ title, subtitle, tasks, lane, expandedTaskId, setExpandedTaskId, onDone, onMove, onEdit, onStart }){
        return (
          <div className="card">
            <div className="cardTitle">
              <h2>{title}</h2>
              <div className="meta">{tasks.length}</div>
            </div>
            <div className="small" style={{marginBottom:10}}>{subtitle}</div>

            {tasks.map(t => {
              const expanded = expandedTaskId === t.id;
              const kindChip =
                t.kind === "ops" ? <span className="chip warn">Ops</span>
                : t.kind === "project" ? <span className="chip good">Project</span>
                : <span className="chip">General</span>;

              return (
                <div className="task" key={t.id}>
                  <div className="taskTop">
                    <div style={{flex:1}}>
                      <p className="taskTitle">{t.title}</p>
                      <div className="taskMeta">
                        {kindChip}
                        <span className="chip gold">{t.timerPreset || 15}m</span>
                      </div>
                    </div>

                    <div className="row" style={{justifyContent:"flex-end"}}>
                      <button className="miniBtn gold" onClick={()=>onStart(t)}>Start</button>
                      <button className="miniBtn good" onClick={()=>onDone(t.id)}>Done</button>
                      {lane !== "today" && <button className="miniBtn" onClick={()=>onMove(t.id,"today")}>→Today</button>}
                      {lane !== "later" && <button className="miniBtn" onClick={()=>onMove(t.id,"later")}>→Later</button>}
                      {lane !== "inbox" && <button className="miniBtn" onClick={()=>onMove(t.id,"inbox")}>→Inbox</button>}
                      <button className="miniBtn" onClick={()=>setExpandedTaskId(expanded ? null : t.id)}>
                        {expanded ? "Hide" : "Details"}
                      </button>
                    </div>
                  </div>

                  {expanded && (
                    <div className="details">
                      <div className="small" style={{marginBottom:6}}><strong>Next tiny step</strong></div>
                      <input
                        className="input"
                        value={t.nextTinyStep || ""}
                        onChange={(e)=>onEdit(t.id, { nextTinyStep: e.target.value })}
                        placeholder="Open X, click Y, do Z…"
                      />

                      <div className="row" style={{marginTop:10}}>
                        <div style={{flex:1, minWidth: 120}}>
                          <div className="small" style={{marginBottom:6}}><strong>Timer</strong></div>
                          <select
                            className="input"
                            value={t.timerPreset || 15}
                            onChange={(e)=>onEdit(t.id, { timerPreset: Number(e.target.value) })}
                          >
                            <option value={15}>15m</option>
                            <option value={25}>25m</option>
                            <option value={45}>45m</option>
                          </select>
                        </div>
                        <div style={{flex:1, minWidth: 140}}>
                          <div className="small" style={{marginBottom:6}}><strong>Type</strong></div>
                          <select
                            className="input"
                            value={t.kind || "general"}
                            onChange={(e)=>onEdit(t.id, { kind: e.target.value })}
                          >
                            <option value="general">General</option>
                            <option value="ops">Ops (Stewardship)</option>
                            <option value="project">Project (Mission)</option>
                          </select>
                        </div>
                      </div>

                      <div className="divider"></div>

                      <div className="small" style={{marginBottom:6}}><strong>Notes</strong> (optional)</div>
                      <textarea
                        className="textarea"
                        value={t.notes || ""}
                        onChange={(e)=>onEdit(t.id, { notes: e.target.value })}
                        placeholder="If needed, keep it short."
                      />
                    </div>
                  )}
                </div>
              );
            })}

            {tasks.length === 0 && <div className="small">No items here.</div>}
          </div>
        );
      }

      function Ledger({ phase, ledger, onPatch }){
        const l = ledger || {
          ora:{prime:false,terce:false,vespers:false,compline:false},
          labora:{stewardship:false,projectBlock:false},
          pugna:{training:false,custody:false},
          mercy:false,
          thanksgiving:"",
          repentance:"",
          obedienceTomorrow:"",
        };

        const hint =
          phase === "morning" ? "Morning: Prime + choose Today + one sprint."
          : phase === "midday" ? "Midday: Terce + stewardship or project block."
          : phase === "evening" ? "Evening: Vespers + examen lines."
          : "Night: keep it minimal; one act of obedience is enough.";

        return (
          <div className="callout">
            <div className="small" style={{marginBottom:10}}>{hint}</div>

            <div className="row" style={{gap:10}}>
              <label className="chip" style={{cursor:"pointer"}}>
                <input type="checkbox" checked={!!l.ora.prime}
                  onChange={()=>onPatch({ ora:{ prime: !l.ora.prime }})} />
                <span>Prime</span>
              </label>
              <label className="chip" style={{cursor:"pointer"}}>
                <input type="checkbox" checked={!!l.ora.terce}
                  onChange={()=>onPatch({ ora:{ terce: !l.ora.terce }})} />
                <span>Terce</span>
              </label>
              <label className="chip" style={{cursor:"pointer"}}>
                <input type="checkbox" checked={!!l.ora.vespers}
                  onChange={()=>onPatch({ ora:{ vespers: !l.ora.vespers }})} />
                <span>Vespers</span>
              </label>
              <label className="chip" style={{cursor:"pointer"}}>
                <input type="checkbox" checked={!!l.ora.compline}
                  onChange={()=>onPatch({ ora:{ compline: !l.ora.compline }})} />
                <span>Compline</span>
              </label>
            </div>

            <div className="divider"></div>

            <div className="row" style={{gap:10}}>
              <label className="chip" style={{cursor:"pointer"}}>
                <input type="checkbox" checked={!!l.labora.stewardship}
                  onChange={()=>onPatch({ labora:{ stewardship: !l.labora.stewardship }})} />
                <span>Stewardship</span>
              </label>
              <label className="chip" style={{cursor:"pointer"}}>
                <input type="checkbox" checked={!!l.labora.projectBlock}
                  onChange={()=>onPatch({ labora:{ projectBlock: !l.labora.projectBlock }})} />
                <span>Project block</span>
              </label>
              <label className="chip" style={{cursor:"pointer"}}>
                <input type="checkbox" checked={!!l.pugna.training}
                  onChange={()=>onPatch({ pugna:{ training: !l.pugna.training }})} />
                <span>Training</span>
              </label>
              <label className="chip" style={{cursor:"pointer"}}>
                <input type="checkbox" checked={!!l.pugna.custody}
                  onChange={()=>onPatch({ pugna:{ custody: !l.pugna.custody }})} />
                <span>Custody</span>
              </label>
              <label className="chip" style={{cursor:"pointer"}}>
                <input type="checkbox" checked={!!l.mercy}
                  onChange={()=>onPatch({ mercy: !l.mercy })} />
                <span>Mercy</span>
              </label>
            </div>

            <div className="divider"></div>

            <div className="small" style={{marginBottom:6}}><strong>Thanksgiving</strong> (1 line)</div>
            <input className="input" value={l.thanksgiving || ""} onChange={(e)=>onPatch({ thanksgiving: e.target.value })} />

            <div className="small" style={{margin:"10px 0 6px"}}><strong>Repentance</strong> (1 line)</div>
            <input className="input" value={l.repentance || ""} onChange={(e)=>onPatch({ repentance: e.target.value })} />

            <div className="small" style={{margin:"10px 0 6px"}}><strong>Tomorrow’s obedience</strong> (1 next act)</div>
            <input className="input" value={l.obedienceTomorrow || ""} onChange={(e)=>onPatch({ obedienceTomorrow: e.target.value })} />
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>