<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Life Dashboard — Minimal MVP (Time-Aware)</title>

    <!-- React 18 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel (fine for static MVP) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      :root{
        --bg:#0b0f14;
        --panel:#101826;
        --panel2:#0f1520;
        --text:#e6edf3;
        --muted:#9fb0c0;
        --line:#1f2a3a;
        --accent:#8ab4f8;
        --chip:#162234;
        --good:#35c07a;
        --warn:#f2c94c;
        --bad:#ff5c5c;
      }
      *{box-sizing:border-box}
      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        background: radial-gradient(1200px 800px at 20% 0%, #101a2b 0%, var(--bg) 55%);
        color:var(--text);
      }
      .app{max-width:1100px;margin:0 auto;padding:16px 14px 34px;}
      .topbar{
        display:flex;gap:10px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
        margin-bottom:12px;
      }
      .title{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
      .title h1{font-size:16px;margin:0;letter-spacing:.2px}
      .subtitle{font-size:12px;color:var(--muted);line-height:1.35}
      .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
      button,input,select,textarea{font:inherit}
      .btn{
        background:linear-gradient(180deg,#152238,#0f1624);
        border:1px solid var(--line);
        color:var(--text);
        padding:8px 10px;border-radius:10px;cursor:pointer;
      }
      .btn:hover{border-color:#2a3a52}
      .btn.primary{background:linear-gradient(180deg,#24406c,#13213a);border-color:#2b4d80}
      .btn.danger{background:linear-gradient(180deg,#5a1d1d,#2a1111);border-color:#7a2a2a}
      .btn.ghost{background:transparent}
      .chip{
        display:inline-flex;align-items:center;gap:6px;
        background:var(--chip);border:1px solid var(--line);
        color:var(--muted);font-size:11px;padding:3px 8px;border-radius:999px;
        white-space:nowrap;
      }
      .chip.good{color:#baf3d6;border-color:#1f6a46}
      .chip.warn{color:#fff1b3;border-color:#6b5a1a}
      .chip.bad{color:#ffb3b3;border-color:#6b1a1a}
      .kpis{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
      .grid{
        display:grid;gap:12px;
        grid-template-columns:1fr;
      }
      @media(min-width:980px){
        .grid{grid-template-columns: 1.35fr .95fr; align-items:start;}
      }
      .card{
        background:linear-gradient(180deg,var(--panel),var(--panel2));
        border:1px solid var(--line);
        border-radius:14px;
        padding:12px;
      }
      .card h2{
        margin:0 0 10px;
        font-size:13px;color:#dbe7f5;
        display:flex;align-items:center;justify-content:space-between;gap:10px;
      }
      .meta{font-size:12px;color:var(--muted);font-weight:500}
      .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
      .input{
        width:100%;
        padding:10px 10px;border-radius:12px;
        border:1px solid var(--line);background:#0b1220;color:var(--text);
      }
      .small{font-size:12px;color:var(--muted);line-height:1.35}
      .three{
        display:grid;gap:12px;
        grid-template-columns:1fr;
      }
      @media(min-width:820px){
        .three{grid-template-columns:1fr 1fr 1fr}
      }
      .list{min-height:170px}
      .task{
        border:1px solid var(--line);
        background:rgba(12,18,32,.70);
        border-radius:12px;
        padding:10px;
        margin-bottom:8px;
      }
      .taskTop{
        display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
      }
      .taskTitle{margin:0;font-size:13px;line-height:1.25}
      .taskMeta{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;align-items:center}
      .miniBtn{
        border-radius:10px;padding:6px 8px;
        border:1px solid var(--line);background:#0b1220;color:var(--text);
        cursor:pointer;font-size:12px;
      }
      .miniBtn:hover{border-color:#2a3a52}
      .miniBtn.good{border-color:#1f6a46}
      .miniBtn.bad{border-color:#6b1a1a}
      .divider{height:1px;background:var(--line);margin:10px 0}
      .details{
        margin-top:8px;
        border:1px solid var(--line);
        background:rgba(12,18,32,.45);
        border-radius:12px;
        padding:10px;
      }
      .textarea{
        width:100%;
        min-height:80px;
        padding:10px;border-radius:12px;
        border:1px solid var(--line);background:#0b1220;color:var(--text);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size:12px;line-height:1.35;
      }
      .toggle{
        display:inline-flex;align-items:center;gap:8px;
        padding:8px 10px;border:1px solid var(--line);
        border-radius:999px;background:rgba(12,18,32,.55);
      }
      .timerBig{
        font-size:40px;
        letter-spacing:0.5px;
        font-weight:700;
        margin:6px 0 2px;
      }
      .timerLabel{
        font-size:12px;color:var(--muted);
      }
      .callout{
        border:1px dashed #2a3a52;
        border-radius:12px;
        padding:10px;
        background:rgba(12,18,32,.35);
      }
      .toast{
        margin-top:10px;
        border:1px solid var(--line);
        border-radius:12px;
        padding:10px;
        background:rgba(12,18,32,.55);
      }
      .toast strong{color:#dbe7f5}
      .modalOverlay{
        position:fixed;inset:0;background:rgba(0,0,0,.55);
        display:flex;align-items:center;justify-content:center;
        padding:16px;
      }
      .modal{
        width:min(700px, 100%);
        max-height: 90vh;
        overflow:auto;
        background:linear-gradient(180deg,var(--panel),var(--panel2));
        border:1px solid var(--line);
        border-radius:14px;
        padding:12px;
      }
      .modalHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
    </style>
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;

      const LS_KEY = "life_dashboard_min_time_v1";

      const MOVES = [
        "1 minute walk (inside or outside).",
        "10 air squats (slow).",
        "10 incline pushups (hands on counter).",
        "30 sec nasal breathing + drop shoulders.",
        "Shoulder CARs x 3 each side.",
        "Hip hinge x 10 (easy range).",
        "Couch stretch 45 sec each side.",
        "Scap circles x 10 + neck release.",
      ];

      function localISODate(d = new Date()){
        const pad = n => String(n).padStart(2,"0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      }
      function uid(){
        return crypto?.randomUUID ? crypto.randomUUID() : String(Date.now())+"_"+Math.random().toString(16).slice(2);
      }
      function safeParseJSON(text){
        try{ return {ok:true, value: JSON.parse(text)}; }
        catch(e){ return {ok:false, error: e?.message || "Invalid JSON"}; }
      }
      function pad2(n){ return String(n).padStart(2,"0"); }
      function fmtTime(d){
        const h = d.getHours();
        const m = d.getMinutes();
        const ampm = h >= 12 ? "PM" : "AM";
        const hh = h % 12 === 0 ? 12 : h % 12;
        return `${hh}:${pad2(m)} ${ampm}`;
      }
      function phaseOfDay(d){
        const h = d.getHours();
        if (h >= 5 && h < 11) return "morning";
        if (h >= 11 && h < 17) return "midday";
        if (h >= 17 && h < 22) return "evening";
        return "night";
      }
      function randMove(){
        return MOVES[Math.floor(Math.random() * MOVES.length)];
      }

      function defaultState(){
        const t = localISODate();
        return {
          meta:{ version: 1, lastOpenedDate: t },
          formation:{
            dailyLedger:[{
              date:t,
              ora:{ prime:false, terce:false, vespers:false, compline:false },
              labora:{ stewardship:false, projectBlock:false },
              pugna:{ training:false, custody:false },
              mercy:false,
              thanksgiving:"",
              repentance:"",
              obedienceTomorrow:"",
            }]
          },
          projects:[
            { id: uid(), name:"Life Admin", status:"active" },
            { id: uid(), name:"Primary Project", status:"active" },
          ],
          tasks:[
            { id: uid(), title:"Capture tasks into Inbox", lane:"inbox", done:false, kind:"general", projectId:null, due:null, notes:"", nextTinyStep:"", timerPreset:15, order:1, createdAt:new Date().toISOString() },
            { id: uid(), title:"Pick Top 3–5 for Today", lane:"today", done:false, kind:"general", projectId:null, due:t, notes:"", nextTinyStep:"Open dashboard → choose 3–5 → start #1.", timerPreset:15, order:2, createdAt:new Date().toISOString() },
            { id: uid(), title:"Make one Stewardship packet (insurance/taxes/docs/credit)", lane:"later", done:false, kind:"ops", projectId:null, due:null, notes:"Create a checklist and gather links/IDs (no passwords).", nextTinyStep:"Create checklist with 5 bullets.", timerPreset:25, order:3, createdAt:new Date().toISOString() },
          ],
        };
      }

      function ensureTodayLedger(formation){
        const t = localISODate();
        const f = formation && typeof formation === "object" ? formation : { dailyLedger: [] };
        const dl = Array.isArray(f.dailyLedger) ? f.dailyLedger : [];
        if (dl.some(e => e.date === t)) return { ...f, dailyLedger: dl };
        return {
          ...f,
          dailyLedger: [...dl, {
            date:t,
            ora:{ prime:false, terce:false, vespers:false, compline:false },
            labora:{ stewardship:false, projectBlock:false },
            pugna:{ training:false, custody:false },
            mercy:false,
            thanksgiving:"",
            repentance:"",
            obedienceTomorrow:"",
          }]
        };
      }

      function normalizeState(s){
        const base = defaultState();
        const obj = (s && typeof s === "object") ? s : base;

        const meta = (obj.meta && typeof obj.meta === "object") ? obj.meta : base.meta;
        const formation = ensureTodayLedger(obj.formation || base.formation);
        const projects = Array.isArray(obj.projects) ? obj.projects : base.projects;
        const tasks = Array.isArray(obj.tasks) ? obj.tasks : base.tasks;

        // Keep Today ≤ 5 (first by order)
        const openToday = tasks.filter(t => t && !t.done && t.lane === "today").sort((a,b)=>(a.order||0)-(b.order||0));
        const overflow = openToday.slice(5).map(t => t.id);
        const tasks2 = tasks.map(t => {
          if (!t || typeof t !== "object") return null;
          const lane = ["inbox","today","later"].includes(t.lane) ? t.lane : "inbox";
          const done = !!t.done;
          const id = String(t.id || uid());
          const out = {
            id,
            title: String(t.title || "").slice(0,240),
            lane,
            done,
            kind: ["general","ops","project"].includes(t.kind) ? t.kind : "general",
            projectId: t.projectId ? String(t.projectId) : null,
            due: t.due ? String(t.due).slice(0,10) : null,
            notes: String(t.notes || "").slice(0,2000),
            nextTinyStep: String(t.nextTinyStep || "").slice(0,200),
            timerPreset: [2,5,10,15,25,45].includes(Number(t.timerPreset)) ? Number(t.timerPreset) : 15,
            order: typeof t.order === "number" ? t.order : Date.now(),
            createdAt: t.createdAt ? String(t.createdAt) : new Date().toISOString(),
          };
          if (overflow.includes(id) && out.lane === "today" && !out.done) out.lane = "later";
          return out;
        }).filter(Boolean);

        return {
          meta: {
            version: 1,
            lastOpenedDate: meta.lastOpenedDate ? String(meta.lastOpenedDate).slice(0,10) : localISODate(),
          },
          formation,
          projects: projects.map(p => ({
            id: String(p.id || uid()),
            name: String(p.name || "Untitled Project").slice(0,120),
            status: ["active","paused","done"].includes(p.status) ? p.status : "active",
          })),
          tasks: tasks2,
        };
      }

      function loadState(){
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return defaultState();
        const parsed = safeParseJSON(raw);
        if (!parsed.ok) return defaultState();
        return normalizeState(parsed.value);
      }
      function saveState(s){
        localStorage.setItem(LS_KEY, JSON.stringify(s, null, 2));
      }

      function getTodayLedger(formation){
        const t = localISODate();
        const f = ensureTodayLedger(formation);
        const e = (f.dailyLedger || []).find(x => x.date === t);
        return e || (f.dailyLedger || [])[f.dailyLedger.length - 1];
      }

      function App(){
        const [state, setState] = useState(() => loadState());
        const [now, setNow] = useState(() => new Date());
        const [showJSON, setShowJSON] = useState(false);
        const [jsonText, setJsonText] = useState("");
        const [jsonMsg, setJsonMsg] = useState("");

        const [newTitle, setNewTitle] = useState("");
        const [newLane, setNewLane] = useState("inbox");
        const [newKind, setNewKind] = useState("general");
        const [newPreset, setNewPreset] = useState(15);

        const [expandedTaskId, setExpandedTaskId] = useState(null);

        const [toast, setToast] = useState("");

        // Timer state
        const [timer, setTimer] = useState({
          mode: "idle",            // "idle" | "focus" | "break"
          running: false,
          secondsLeft: 0,
          taskId: null,
          movePrompt: "",
        });

        // tick clock
        useEffect(() => {
          const id = setInterval(() => setNow(new Date()), 1000);
          return () => clearInterval(id);
        }, []);

        // daily rollover
        useEffect(() => {
          const t = localISODate();
          if (state.meta.lastOpenedDate !== t) {
            // Move stale Today to Later, reset ledger lines for today (new entry), stop timer
            const next = {
              ...state,
              meta: { ...state.meta, lastOpenedDate: t },
              tasks: state.tasks.map(task => {
                if (task.lane === "today" && !task.done) return { ...task, lane: "later" };
                return task;
              }),
              formation: ensureTodayLedger(state.formation),
            };
            setState(normalizeState(next));
            setTimer({ mode:"idle", running:false, secondsLeft:0, taskId:null, movePrompt:"" });
            setToast("New day: moved unfinished Today items to Later.");
          } else {
            // ensure ledger exists (e.g. after import)
            setState(prev => normalizeState(prev));
          }
          // eslint-disable-next-line react-hooks/exhaustive-deps
        }, []);

        useEffect(() => saveState(state), [state]);

        // timer tick
        useEffect(() => {
          if (!timer.running) return;
          const id = setInterval(() => {
            setTimer(prev => {
              if (!prev.running) return prev;
              const next = { ...prev, secondsLeft: Math.max(0, prev.secondsLeft - 1) };
              if (next.secondsLeft <= 0) {
                // end
                if (prev.mode === "focus") {
                  const prompt = randMove();
                  setToast("Focus complete. Take a movement break.");
                  return { mode:"break", running:false, secondsLeft: 2*60, taskId: prev.taskId, movePrompt: prompt };
                }
                if (prev.mode === "break") {
                  setToast("Break complete. Start the next focus.");
                  return { mode:"idle", running:false, secondsLeft:0, taskId:null, movePrompt:"" };
                }
              }
              return next;
            });
          }, 1000);
          return () => clearInterval(id);
        }, [timer.running]);

        const phase = phaseOfDay(now);

        const tasksOpen = useMemo(() => state.tasks.filter(t => !t.done), [state.tasks]);

        const tasksByLane = useMemo(() => {
          const lanes = { inbox: [], today: [], later: [] };
          const sorted = [...tasksOpen].sort((a,b)=>(a.order||0)-(b.order||0));
          for (const t of sorted) lanes[t.lane].push(t);
          return lanes;
        }, [tasksOpen]);

        const kpis = useMemo(() => {
          const open = tasksOpen.length;
          const todayCount = tasksByLane.today.length;
          const done = state.tasks.filter(t => t.done).length;
          return { open, todayCount, done };
        }, [tasksOpen, tasksByLane.today.length, state.tasks]);

        const todayLedger = useMemo(() => getTodayLedger(state.formation), [state.formation]);

        const currentTask = useMemo(() => {
          if (!timer.taskId) return null;
          return state.tasks.find(t => t.id === timer.taskId) || null;
        }, [timer.taskId, state.tasks]);

        function commit(next){
          setState(normalizeState(next));
        }

        function addTask(){
          const title = newTitle.trim();
          if (!title) return;
          const task = {
            id: uid(),
            title,
            lane: newLane,
            done: false,
            kind: newKind,
            projectId: null,
            due: null,
            notes: "",
            nextTinyStep: "",
            timerPreset: Number(newPreset) || 15,
            order: Date.now(),
            createdAt: new Date().toISOString(),
          };
          const next = { ...state, tasks: [...state.tasks, task] };
          commit(next);
          setNewTitle("");
        }

        function toggleDone(taskId){
          const next = {
            ...state,
            tasks: state.tasks.map(t => t.id === taskId ? { ...t, done: !t.done } : t)
          };
          commit(next);
        }

        function moveTask(taskId, lane){
          const next = {
            ...state,
            tasks: state.tasks.map(t => t.id === taskId ? { ...t, lane } : t)
          };
          commit(next);
        }

        function editTask(taskId, patch){
          const next = {
            ...state,
            tasks: state.tasks.map(t => t.id === taskId ? { ...t, ...patch } : t)
          };
          commit(next);
        }

        function updateLedger(patch){
          const t = localISODate();
          const f = ensureTodayLedger(state.formation);
          const dl = (f.dailyLedger || []).map(e => {
            if (e.date !== t) return e;
            return deepMerge(e, patch);
          });
          commit({ ...state, formation: { ...f, dailyLedger: dl } });
        }

        function deepMerge(a, b){
          const out = { ...a };
          for (const k of Object.keys(b || {})) {
            const v = b[k];
            if (v && typeof v === "object" && !Array.isArray(v)) {
              out[k] = deepMerge(a?.[k] || {}, v);
            } else {
              out[k] = v;
            }
          }
          return out;
        }

        function resetAll(){
          if (!confirm("Reset everything to defaults? This wipes local data.")) return;
          commit(defaultState());
          setTimer({ mode:"idle", running:false, secondsLeft:0, taskId:null, movePrompt:"" });
          setToast("Reset.");
        }

        // JSON export/import
        function exportJSON(){
          const text = JSON.stringify(state, null, 2);
          setJsonText(text);
          setShowJSON(true);
          setJsonMsg("");
          navigator.clipboard?.writeText(text).then(
            () => setJsonMsg("Copied JSON ✅"),
            () => setJsonMsg("Copy manually from the box.")
          );
        }
        function importJSON(){
          const parsed = safeParseJSON(jsonText);
          if (!parsed.ok) { setJsonMsg("Import failed: " + parsed.error); return; }
          commit(parsed.value);
          setShowJSON(false);
          setJsonMsg("Imported ✅");
          setToast("Imported state.");
        }

        // Timer controls
        function startFocusForTask(task){
          const mins = Number(task.timerPreset) || 15;
          const step = (task.nextTinyStep || "").trim();
          setTimer({
            mode: "focus",
            running: true,
            secondsLeft: mins * 60,
            taskId: task.id,
            movePrompt: "",
          });
          setToast(step ? `Start: ${step}` : "Start focus.");
        }

        function startTopToday(){
          const top = tasksByLane.today[0];
          if (!top) { setToast("No Today tasks. Move one from Later."); return; }
          startFocusForTask(top);
        }

        function toggleTimerRun(){
          setTimer(prev => {
            if (prev.mode === "idle") return prev;
            return { ...prev, running: !prev.running };
          });
        }

        function resetTimer(){
          setTimer({ mode:"idle", running:false, secondsLeft:0, taskId:null, movePrompt:"" });
          setToast("Timer reset.");
        }

        function setFocusPreset(mins){
          // Set focus length for current task (or next)
          setTimer(prev => {
            if (prev.mode !== "focus" || !prev.taskId) return prev;
            return { ...prev, secondsLeft: mins*60, running: false };
          });
        }

        function setBreakPreset(mins){
          setTimer(prev => {
            if (prev.mode !== "break") return prev;
            return { ...prev, secondsLeft: mins*60, running: false };
          });
        }

        function startBreakNow(){
          setTimer(prev => {
            const prompt = prev.movePrompt || randMove();
            return { mode:"break", running:true, secondsLeft: prev.secondsLeft > 0 ? prev.secondsLeft : 2*60, taskId: prev.taskId, movePrompt: prompt };
          });
        }

        function completeCurrentTask(){
          if (!currentTask) return;
          toggleDone(currentTask.id);
          setToast("Marked done ✅");
        }

        function fmtMMSS(sec){
          const m = Math.floor(sec / 60);
          const s = sec % 60;
          return `${m}:${pad2(s)}`;
        }

        const phaseChip = useMemo(() => {
          const map = {
            morning: { kind: "good", label: "Morning" },
            midday: { kind: "warn", label: "Midday" },
            evening: { kind: "", label: "Evening" },
            night: { kind: "bad", label: "Night" },
          };
          return map[phase] || { kind:"", label: phase };
        }, [phase]);

        return (
          <div className="app">
            <div className="topbar">
              <div className="title">
                <h1>Life Dashboard</h1>
                <div className="subtitle">
                  <span className={`chip ${phaseChip.kind}`}>{phaseChip.label}</span>{" "}
                  <span className="chip">{fmtTime(now)}</span>{" "}
                  <span className="chip">{localISODate(now)}</span>
                  <div className="small" style={{marginTop:6}}>
                    Minimal MVP: <strong>Today ≤ 5</strong> • Inbox capture • Later holds Ops/Projects.
                  </div>
                </div>
              </div>

              <div className="controls">
                <div className="kpis">
                  <span className="chip">Open: {kpis.open}</span>
                  <span className={`chip ${kpis.todayCount > 5 ? "bad" : ""}`}>Today: {kpis.todayCount}/5</span>
                  <span className="chip">Done: {kpis.done}</span>
                </div>
                <button className="btn primary" onClick={startTopToday}>Start Top Today</button>
                <button className="btn" onClick={exportJSON}>Export JSON</button>
                <button className="btn" onClick={() => setShowJSON(v=>!v)}>Import/Inspect</button>
                <button className="btn danger" onClick={resetAll}>Reset</button>
              </div>
            </div>

            <div className="grid">
              {/* LEFT: lists */}
              <div className="card">
                <h2>
                  <span>Work Mat</span>
                  <span className="meta">Do the next tiny step. Timer + movement break. Repeat.</span>
                </h2>

                <div className="row" style={{marginBottom:10}}>
                  <input
                    className="input"
                    placeholder="Quick add… (Enter to save)"
                    value={newTitle}
                    onChange={(e)=>setNewTitle(e.target.value)}
                    onKeyDown={(e)=>{ if(e.key==="Enter") addTask(); }}
                  />
                </div>

                <div className="row" style={{marginBottom:10}}>
                  <select className="input" value={newLane} onChange={(e)=>setNewLane(e.target.value)} style={{maxWidth:170}}>
                    <option value="inbox">Inbox</option>
                    <option value="today">Today</option>
                    <option value="later">Later</option>
                  </select>

                  <select className="input" value={newKind} onChange={(e)=>setNewKind(e.target.value)} style={{maxWidth:170}}>
                    <option value="general">General</option>
                    <option value="ops">Ops (Stewardship)</option>
                    <option value="project">Project (Mission)</option>
                  </select>

                  <select className="input" value={newPreset} onChange={(e)=>setNewPreset(Number(e.target.value))} style={{maxWidth:140}}>
                    <option value={15}>15m</option>
                    <option value={25}>25m</option>
                    <option value={45}>45m</option>
                  </select>

                  <button className="btn primary" onClick={addTask}>Add</button>
                </div>

                <div className="three">
                  <Lane
                    title="Today (≤ 5)"
                    hint="Only what you will actually do."
                    tasks={tasksByLane.today}
                    lane="today"
                    expandedTaskId={expandedTaskId}
                    setExpandedTaskId={setExpandedTaskId}
                    onDone={toggleDone}
                    onMove={moveTask}
                    onEdit={editTask}
                    onStart={startFocusForTask}
                  />
                  <Lane
                    title="Inbox"
                    hint="Capture only. No deciding here."
                    tasks={tasksByLane.inbox}
                    lane="inbox"
                    expandedTaskId={expandedTaskId}
                    setExpandedTaskId={setExpandedTaskId}
                    onDone={toggleDone}
                    onMove={moveTask}
                    onEdit={editTask}
                    onStart={startFocusForTask}
                  />
                  <Lane
                    title="Later"
                    hint="Everything else (Ops/Projects live here)."
                    tasks={tasksByLane.later}
                    lane="later"
                    expandedTaskId={expandedTaskId}
                    setExpandedTaskId={setExpandedTaskId}
                    onDone={toggleDone}
                    onMove={moveTask}
                    onEdit={editTask}
                    onStart={startFocusForTask}
                  />
                </div>

                {toast && (
                  <div className="toast">
                    <strong>Note:</strong> <span className="small">{toast}</span>
                    <div style={{marginTop:8}}>
                      <button className="miniBtn" onClick={()=>setToast("")}>Dismiss</button>
                    </div>
                  </div>
                )}
              </div>

              {/* RIGHT: time-aware + formation + JSON */}
              <div className="card">
                <h2>
                  <span>Time-aware Focus</span>
                  <span className="meta">Short sprints + movement breaks (ADD-friendly).</span>
                </h2>

                <div className="callout">
                  <div className="row" style={{justifyContent:"space-between"}}>
                    <div>
                      <div className="timerLabel">
                        {timer.mode === "idle" ? "Idle" : timer.mode === "focus" ? "Focus" : "Break"}
                        {currentTask ? ` • ${currentTask.title}` : ""}
                      </div>
                      <div className="timerBig">
                        {timer.mode === "idle" ? "—:—" : fmtMMSS(timer.secondsLeft)}
                      </div>
                      <div className="small">
                        {timer.mode === "focus" && currentTask?.nextTinyStep ? (
                          <>Next tiny step: <strong>{currentTask.nextTinyStep}</strong></>
                        ) : timer.mode === "break" && timer.movePrompt ? (
                          <>Move: <strong>{timer.movePrompt}</strong></>
                        ) : (
                          <>Tip: start the top Today task, then obey the timer.</>
                        )}
                      </div>
                    </div>

                    <div className="row" style={{justifyContent:"flex-end"}}>
                      <button className="btn primary" onClick={toggleTimerRun} disabled={timer.mode==="idle"}>
                        {timer.running ? "Pause" : "Start"}
                      </button>
                      <button className="btn" onClick={resetTimer}>Reset</button>
                    </div>
                  </div>

                  <div className="divider"></div>

                  <div className="row" style={{justifyContent:"space-between"}}>
                    <div className="small">
                      Focus presets:
                      <span style={{marginLeft:8}} />
                      <button className="miniBtn" onClick={()=>setFocusPreset(15)} disabled={timer.mode!=="focus"}>15m</button>{" "}
                      <button className="miniBtn" onClick={()=>setFocusPreset(25)} disabled={timer.mode!=="focus"}>25m</button>{" "}
                      <button className="miniBtn" onClick={()=>setFocusPreset(45)} disabled={timer.mode!=="focus"}>45m</button>
                    </div>

                    <div className="small">
                      Break presets:
                      <span style={{marginLeft:8}} />
                      <button className="miniBtn" onClick={()=>setBreakPreset(2)} disabled={timer.mode!=="break"}>2m</button>{" "}
                      <button className="miniBtn" onClick={()=>setBreakPreset(5)} disabled={timer.mode!=="break"}>5m</button>{" "}
                      <button className="miniBtn good" onClick={startBreakNow} disabled={timer.mode!=="break"}>Start break</button>
                    </div>
                  </div>

                  <div style={{marginTop:10}} className="row">
                    <button className="miniBtn good" onClick={completeCurrentTask} disabled={!currentTask}>
                      Mark current task done ✅
                    </button>
                    <button
                      className="miniBtn"
                      onClick={()=>{
                        const nextPrompt = randMove();
                        setTimer(prev => prev.mode==="break" ? { ...prev, movePrompt: nextPrompt } : prev);
                      }}
                      disabled={timer.mode!=="break"}
                    >
                      New move
                    </button>
                  </div>
                </div>

                <div className="divider"></div>

                <h2>
                  <span>Rule Ledger (private)</span>
                  <span className="meta">Minimal fidelity: Ora • Labora • Pugna + Mercy.</span>
                </h2>

                <Ledger
                  phase={phase}
                  ledger={todayLedger}
                  onPatch={updateLedger}
                />

                <div className="divider"></div>

                <h2>
                  <span>JSON Round-trip</span>
                  <span className="meta">Export → paste to ChatGPT → import back.</span>
                </h2>

                <div className="small" style={{marginBottom:8}}>
                  Use this prompt with your export: <br/>
                  <span className="chip">“Set Today ≤ 5, write tiny steps for each, assign timers, add a 2-line invocation + 3-line examen, return updated JSON only.”</span>
                </div>

                {showJSON ? (
                  <>
                    <textarea
                      className="textarea"
                      value={jsonText}
                      onChange={(e)=>setJsonText(e.target.value)}
                      placeholder="Paste JSON here to import…"
                      style={{minHeight:180}}
                    />
                    <div className="row" style={{justifyContent:"space-between", marginTop:8}}>
                      <div className="small">{jsonMsg}</div>
                      <div className="row">
                        <button className="btn" onClick={()=>setShowJSON(false)}>Close</button>
                        <button className="btn primary" onClick={importJSON}>Import JSON</button>
                      </div>
                    </div>
                  </>
                ) : (
                  <div className="small">
                    Click <strong>Export JSON</strong> on the left toolbar, paste into ChatGPT, then paste the returned JSON here.
                  </div>
                )}
              </div>
            </div>

            {/* Break modal prompt when focus ends */}
            {timer.mode === "break" && !timer.running && timer.secondsLeft > 0 && (
              <div className="modalOverlay" role="dialog" aria-modal="true">
                <div className="modal">
                  <div className="modalHeader">
                    <div>
                      <strong>Movement break</strong>
                      <div className="small">Do this now, then start the break timer.</div>
                    </div>
                    <button className="btn ghost" onClick={()=>setTimer({mode:"idle",running:false,secondsLeft:0,taskId:null,movePrompt:""})}>✕</button>
                  </div>
                  <div className="callout">
                    <div className="small">Move:</div>
                    <div style={{marginTop:6, fontSize:14}}><strong>{timer.movePrompt || randMove()}</strong></div>
                    <div className="divider"></div>
                    <div className="row">
                      <button className="btn primary" onClick={startBreakNow}>Start break timer</button>
                      <button className="btn" onClick={()=>setTimer(prev=>({ ...prev, movePrompt: randMove() }))}>New move</button>
                      <button className="btn" onClick={()=>setTimer({mode:"idle",running:false,secondsLeft:0,taskId:null,movePrompt:""})}>Skip</button>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      function Lane({ title, hint, tasks, lane, expandedTaskId, setExpandedTaskId, onDone, onMove, onEdit, onStart }){
        return (
          <div className="card list" style={{padding:10}}>
            <h2>
              <span>{title}</span>
              <span className="meta">{tasks.length}</span>
            </h2>
            <div className="small" style={{marginBottom:8}}>{hint}</div>

            {tasks.map(t => {
              const expanded = expandedTaskId === t.id;
              const kindChip =
                t.kind === "ops" ? <span className="chip warn">Ops</span>
                : t.kind === "project" ? <span className="chip good">Project</span>
                : <span className="chip">General</span>;

              return (
                <div className="task" key={t.id}>
                  <div className="taskTop">
                    <div style={{flex:1}}>
                      <p className="taskTitle">{t.title}</p>
                      <div className="taskMeta">
                        {kindChip}
                        <span className="chip">{t.timerPreset || 15}m</span>
                      </div>
                    </div>
                    <div className="row" style={{justifyContent:"flex-end"}}>
                      <button className="miniBtn good" onClick={()=>onStart(t)}>Start</button>
                      <button className="miniBtn" onClick={()=>onDone(t.id)}>Done</button>
                      {lane !== "today" && <button className="miniBtn" onClick={()=>onMove(t.id,"today")}>→Today</button>}
                      {lane !== "later" && <button className="miniBtn" onClick={()=>onMove(t.id,"later")}>→Later</button>}
                      {lane !== "inbox" && <button className="miniBtn" onClick={()=>onMove(t.id,"inbox")}>→Inbox</button>}
                      <button className="miniBtn" onClick={()=>setExpandedTaskId(expanded ? null : t.id)}>
                        {expanded ? "Hide" : "Details"}
                      </button>
                    </div>
                  </div>

                  {expanded && (
                    <div className="details">
                      <div className="small" style={{marginBottom:6}}><strong>Next tiny step</strong> (≤ 1 line)</div>
                      <input
                        className="input"
                        value={t.nextTinyStep || ""}
                        onChange={(e)=>onEdit(t.id, { nextTinyStep: e.target.value })}
                        placeholder="Open X, click Y, do Z…"
                      />

                      <div className="row" style={{marginTop:10}}>
                        <div style={{flex:1}}>
                          <div className="small" style={{marginBottom:6}}><strong>Timer</strong></div>
                          <select
                            className="input"
                            value={t.timerPreset || 15}
                            onChange={(e)=>onEdit(t.id, { timerPreset: Number(e.target.value) })}
                          >
                            <option value={15}>15m</option>
                            <option value={25}>25m</option>
                            <option value={45}>45m</option>
                          </select>
                        </div>
                        <div style={{flex:1}}>
                          <div className="small" style={{marginBottom:6}}><strong>Type</strong></div>
                          <select
                            className="input"
                            value={t.kind || "general"}
                            onChange={(e)=>onEdit(t.id, { kind: e.target.value })}
                          >
                            <option value="general">General</option>
                            <option value="ops">Ops (Stewardship)</option>
                            <option value="project">Project (Mission)</option>
                          </select>
                        </div>
                      </div>

                      <div className="divider"></div>
                      <div className="small" style={{marginBottom:6}}><strong>Notes</strong> (optional)</div>
                      <textarea
                        className="textarea"
                        value={t.notes || ""}
                        onChange={(e)=>onEdit(t.id, { notes: e.target.value })}
                        placeholder="If needed, keep it short."
                      />
                    </div>
                  )}
                </div>
              );
            })}

            {tasks.length === 0 && <div className="small">No items here.</div>}
          </div>
        );
      }

      function Ledger({ phase, ledger, onPatch }){
        const l = ledger || {
          ora:{prime:false,terce:false,vespers:false,compline:false},
          labora:{stewardship:false,projectBlock:false},
          pugna:{training:false,custody:false},
          mercy:false,
          thanksgiving:"",
          repentance:"",
          obedienceTomorrow:"",
        };

        // gentle time-aware hint
        const hint =
          phase === "morning" ? "Morning: Prime + choose Today + start one sprint."
          : phase === "midday" ? "Midday: Terce + stewardship or project block."
          : phase === "evening" ? "Evening: Vespers + examen lines."
          : "Night: keep it minimal; one act of obedience is enough.";

        return (
          <div className="callout">
            <div className="small" style={{marginBottom:8}}>{hint}</div>

            <div className="row" style={{gap:10}}>
              <label className="toggle">
                <input type="checkbox" checked={!!l.ora.prime}
                  onChange={()=>onPatch({ ora:{ prime: !l.ora.prime }})} />
                Prime
              </label>
              <label className="toggle">
                <input type="checkbox" checked={!!l.ora.terce}
                  onChange={()=>onPatch({ ora:{ terce: !l.ora.terce }})} />
                Terce
              </label>
              <label className="toggle">
                <input type="checkbox" checked={!!l.ora.vespers}
                  onChange={()=>onPatch({ ora:{ vespers: !l.ora.vespers }})} />
                Vespers
              </label>
              <label className="toggle">
                <input type="checkbox" checked={!!l.ora.compline}
                  onChange={()=>onPatch({ ora:{ compline: !l.ora.compline }})} />
                Compline
              </label>
            </div>

            <div className="divider"></div>

            <div className="row" style={{gap:10}}>
              <label className="toggle">
                <input type="checkbox" checked={!!l.labora.stewardship}
                  onChange={()=>onPatch({ labora:{ stewardship: !l.labora.stewardship }})} />
                Stewardship
              </label>
              <label className="toggle">
                <input type="checkbox" checked={!!l.labora.projectBlock}
                  onChange={()=>onPatch({ labora:{ projectBlock: !l.labora.projectBlock }})} />
                Project block
              </label>
              <label className="toggle">
                <input type="checkbox" checked={!!l.pugna.training}
                  onChange={()=>onPatch({ pugna:{ training: !l.pugna.training }})} />
                Training
              </label>
              <label className="toggle">
                <input type="checkbox" checked={!!l.pugna.custody}
                  onChange={()=>onPatch({ pugna:{ custody: !l.pugna.custody }})} />
                Custody
              </label>
              <label className="toggle">
                <input type="checkbox" checked={!!l.mercy}
                  onChange={()=>onPatch({ mercy: !l.mercy })} />
                Mercy
              </label>
            </div>

            <div className="divider"></div>

            <div className="small" style={{marginBottom:6}}><strong>Thanksgiving</strong> (1 line)</div>
            <input className="input" value={l.thanksgiving || ""} onChange={(e)=>onPatch({ thanksgiving: e.target.value })} />

            <div className="small" style={{margin:"10px 0 6px"}}><strong>Repentance</strong> (1 line)</div>
            <input className="input" value={l.repentance || ""} onChange={(e)=>onPatch({ repentance: e.target.value })} />

            <div className="small" style={{margin:"10px 0 6px"}}><strong>Tomorrow’s obedience</strong> (1 next act)</div>
            <input className="input" value={l.obedienceTomorrow || ""} onChange={(e)=>onPatch({ obedienceTomorrow: e.target.value })} />
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>